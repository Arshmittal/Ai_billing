<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>245D Compliance Scheduling</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Blur only the background (calendar & sidebar), NOT the modal */
        .blur-background #calendar, 
        .blur-background .sidebar {
            filter: blur(5px);
            transition: filter 0.3s ease-in-out;
        }

        /* Modal styles (remains clear and sharp) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5); /* Dark overlay */
            backdrop-filter: blur(6px); /* Smooth background blur */
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 50;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        /* Event appearance settings */
        .fc-event-title {
            font-weight: bold;
        }

        /* Ensure event is visible on start date and properly formatted */
        .fc-daygrid-event {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
            padding: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body class="font-roboto bg-gray-100 text-gray-800">

    <div class="flex" id="mainContainer">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white h-screen p-4 sidebar">
            <div class="flex items-center space-x-3">
                <img src="/static/default-profile.png" alt="Profile" class="w-12 h-12 rounded-full">
                <h2 class="text-lg font-semibold">{{ user.name }}</h2>
            </div>
            
            <nav class="mt-6">
                <a href="/schedule" class="block py-2 px-4 hover:bg-gray-700 rounded">SCHEDULING</a>
                
                <!-- Billing Dropdown -->
                <div class="group">
                    <button class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded focus:outline-none">
                        BILLING ▼
                    </button>
                    <div class="hidden group-hover:block pl-4">
                        <a href="/generateClaims" class="block py-2 px-4 hover:bg-gray-700 rounded">Generate Claims</a>
                        <a href="/generate-invoice" class="block py-2 px-4 hover:bg-gray-700 rounded">Generate Invoice</a>
                        <a href="/view-invoice" class="block py-2 px-4 hover:bg-gray-700 rounded">View Invoice</a>
                    </div>
                </div>
        
                <a href="/billing_dashboard" class="block py-2 px-4 hover:bg-gray-700 rounded">DASHBOARDS</a>
                
                <a href="/create-shift-front" id="eventsNav" class="block py-2 px-4 hover:bg-gray-700 rounded">EVENTS</a>
        
                <!-- CRM Dropdown -->
                <div class="group">
                    <button class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded focus:outline-none">
                        CRM ▼
                    </button>
                    <div class="hidden group-hover:block pl-4">
                        <a href="/add-client" class="block py-2 px-4 hover:bg-gray-700 rounded">Add Client</a>
                        <a href="/view-client" class="block py-2 px-4 hover:bg-gray-700 rounded">View Client</a>
                    </div>
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 p-6">
            <h1 class="text-3xl font-bold mb-6">245D Compliance Scheduling</h1>
            <div id="calendar"></div>

            <!-- Shift Details Modal -->
            <div id="eventDetailsModal" class="modal-overlay hidden">
                <div class="modal-content">
                    <h2 class="text-xl font-bold mb-3 text-center">Shift Details</h2>
                    <div class="text-gray-700 space-y-2">
                        <p><strong>Title:</strong> <span id="eventTitle"></span></p>
                        <p><strong>Staff Name:</strong> <span id="staffName"></span></p>
                        <p><strong>Email:</strong> <span id="staffEmail"></span></p>
                        <p><strong>Service Type:</strong> <span id="serviceType"></span></p>
                        <p><strong>Start:</strong> <span id="eventStart"></span></p>
                        <p><strong>End:</strong> <span id="eventEnd"></span></p>
                        <p><strong>Clock In:</strong> <span id="clockIn"></span></p>
                        <p><strong>Clock Out:</strong> <span id="clockOut"></span></p>
                        <p><strong>Internal Notes:</strong> <span id="internalNotes"></span></p>
                        <p>
                            <a id="eventLink" href="#" target="_blank" class="text-blue-500 underline hidden">
                                View in Google Calendar
                            </a>
                        </p>
                    </div>
                    <div class="modal-buttons">
                        <button id="closeModal" class="bg-gray-600 text-white px-4 py-2 rounded w-1/3">Close</button>
                        <button id="deleteEvent" class="bg-red-600 text-white px-4 py-2 rounded w-1/3">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var eventDetailsModal = document.getElementById('eventDetailsModal');
            var deleteEventBtn = document.getElementById('deleteEvent');
            var closeModalBtn = document.getElementById('closeModal');
            var mainContainer = document.getElementById('mainContainer');

            let selectedEventId = null; // Store the event ID for deletn

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: '/get-shifts', // Fetch shifts from backend
                
                eventClick: function(info) {
                    selectedEventId = info.event.id; // Store event ID for deletion

                    document.getElementById("eventTitle").innerText = info.event.title;
                    document.getElementById("staffName").innerText = info.event.extendedProps.staffName;
                    document.getElementById("staffEmail").innerText = info.event.extendedProps.staffEmail;
                    document.getElementById("serviceType").innerText = info.event.extendedProps.serviceType;
                    document.getElementById("eventStart").innerText = new Date(info.event.start).toLocaleString();
                    document.getElementById("eventEnd").innerText = info.event.end ? new Date(info.event.end).toLocaleString() : "N/A";
                    document.getElementById("clockIn").innerText = info.event.extendedProps.clockIn;
                    document.getElementById("clockOut").innerText = info.event.extendedProps.clockOut;
                    document.getElementById("internalNotes").innerText = info.event.extendedProps.internalNotes || "No description";

                    if (info.event.extendedProps.eventLink) {
                        document.getElementById("eventLink").href = info.event.extendedProps.eventLink;
                        document.getElementById("eventLink").classList.remove("hidden");
                    } else {
                        document.getElementById("eventLink").classList.add("hidden");
                    }

                    eventDetailsModal.classList.remove("hidden");
                    mainContainer.classList.add("blur-background"); // Apply blur to background only
                }
            });

            calendar.render();

            // Close Modal
            closeModalBtn.addEventListener('click', function() {
                eventDetailsModal.classList.add("hidden");
                mainContainer.classList.remove("blur-background"); // Remove blur
            });

            // DELETE Event
            deleteEventBtn.addEventListener('click', function() {
                if (!selectedEventId) {
                    alert("Error: No event selected for deletion.");
                    return;
                }

                if (confirm("Are you sure you want to delete this shift?")) {
                    fetch(`/delete-shift/${selectedEventId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            eventDetailsModal.classList.add("hidden");
                            mainContainer.classList.remove("blur-background");
                            calendar.refetchEvents(); // Refresh calendar after deletion
                        })
                        .catch(error => alert("Error deleting event: " + error));
                }
            });
        });
    </script>

</body>
</html>
