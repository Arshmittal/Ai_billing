<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-alt mr-2"></i>
                    <h5 class="mb-0">Generate Document</h5>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-minus"></i></button>
                    <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-expand"></i></button>
                    <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </div>
        
        <div class="row main-content">
            <div class="col-md-3">
                <div class="form-group">
                    <label>Client</label>
                    <div class="input-group">
                        <input type="text" id="client_name" class="form-control" value="ABDI, HAYAT (05051184) - (12/28/2019)">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="form-group">
                    <label>Document Type</label>
                    <div class="input-group">
                        <input type="text" id="document_type" class="form-control" value="245D Data Privacy Policy">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <button id="generate_btn" class="btn btn-primary mt-4">
                    <i class="fas fa-file-export mr-1"></i> Generate & Send Document
                </button>
            </div>
        </div>
        
        <div class="row document-preview">
            <div class="col-md-8">
                <div class="document-container">
                    <div class="document-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-sm btn-tool"><i class="fas fa-list"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-filter"></i></button>
                            <button class="btn btn-sm btn-tool dropdown-toggle"></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-ellipsis-h"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-minus"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-plus"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-image"></i></button>
                        </div>
                        <div class="toolbar-middle">
                            <span>3</span> of <span>3</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-sm btn-tool"><i class="fas fa-redo"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-file-download"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-search"></i></button>
                            <button class="btn btn-sm btn-tool"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    </div>
                    <div class="document-content">
                        <div id="document_preview" class="pdf-content">
                            <!-- PDF preview will be loaded here -->
                            <div class="document-page">
                                <h3 class="text-center">MN Department of Human Services • Office of Inspector General Licensing Division • 245D HCBS POLICY</h3>
                                
                                <div class="section">
                                    <h4>E. Individual access to private data.</h4>
                                    <p>Individuals or their legal representatives have a right to access and review the individual record.</p>
                                    <ol>
                                        <li>A staff person will be present during the review and will make an entry in the person's progress notes as to the person who accessed the record, date and time of review, and list any copies made from the record.</li>
                                        <li>An individual may challenge the accuracy or completeness of information contained in the record. Staff will refer the individual to the grievance policy for lodging a complaint.</li>
                                        <li>Individuals may request copies of pages in their record.</li>
                                        <li>No individual, legal representative, staff person, or anyone else may permanently remove or destroy any portion of the person's record.</li>
                                    </ol>
                                </div>
                                
                                <div class="section">
                                    <h4>F. Case manager access to private data.</h4>
                                    <p>A person's case manager and the foster care licensor have access to the records of person's served by the program under section 245D.095, subd. 4.</p>
                                </div>
                                
                                <div class="section">
                                    <h4>G. Requesting information from other licensed caregivers or primary health care providers.</h4>
                                    <ol>
                                        <li>Complete the attached release of information authorization form. Carefully list all the consults, reports or assessments needed, giving specific dates whenever possible. Also, identify the purpose for the request.</li>
                                        <li>Clearly identify the person or agency requiring the information. If information is to be sent to the program's health care consultant or other staff at the program, include Attention: (name of person to receive the information), and the name and address of the program.</li>
                                        <li>Assure informed consent to share the requested private data with the person or entity has been obtained from the person or the legal representative.</li>
                                        <li>Keep the document in the person's record.</li>
                                    </ol>
                                </div>
                                
                                <div class="signature-section">
                                    <p>Policy reviewed and authorized by:</p>
                                    <div class="signature-line">
                                        <span>Print name & title</span>
                                        <span>Signature</span>
                                    </div>
                                    <div class="date-line">
                                        <span>Date of last policy review: ____________________</span>
                                        <span>Date of last policy revision: ____________________</span>
                                    </div>
                                    <p>Legal Authority: MS § <a href="#">245D.11</a>, subd. 3</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="form-section">
                    <div class="form-group">
                        <label for="program_name">Program name</label>
                        <input type="text" id="program_name" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="print_name_title">Print name & title</label>
                        <input type="text" id="print_name_title" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="date_review">Date of last policy review:</label>
                        <input type="date" id="date_review" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="date_revision">Date of last policy revision:</label>
                        <input type="date" id="date_revision" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label>Signature</label>
                        <div id="signature-pad" class="signature-pad">
                            <canvas></canvas>
                            <div class="signature-pad-footer">
                                <button type="button" id="clear-signature" class="btn btn-sm btn-secondary">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="agree_checkbox">
                        <label class="form-check-label" for="agree_checkbox">
                            I agree to electronically sign this form.
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button id="accept_btn" class="btn btn-primary">Accept</button>
                        <button id="clear_btn" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // static/js/scripts.js
document.addEventListener('DOMContentLoaded', function() {
    // Initialize signature pad
    const canvas = document.querySelector('#signature-pad canvas');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)'
    });
    
    // Handle window resize
    window.addEventListener('resize', resizeCanvas);
    
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear(); // Otherwise isEmpty() might return incorrect value
    }
    
    resizeCanvas();
    
    // Clear signature button
    document.getElementById('clear-signature').addEventListener('click', function() {
        signaturePad.clear();
    });
    
    // Handle form submission
    document.getElementById('accept_btn').addEventListener('click', function() {
        if (signaturePad.isEmpty()) {
            alert('Please provide a signature');
            return;
        }
        
        if (!document.getElementById('agree_checkbox').checked) {
            alert('Please check the agreement checkbox');
            return;
        }
        
        // Create form data with all fields
        const formData = collectFormData();
        formData.append('signature', signaturePad.toDataURL());
        
        // Preview the PDF
        previewDocument(formData);
    });
    
    // Generate and download PDF
    document.getElementById('generate_btn').addEventListener('click', function() {
        // Create form data with all fields
        const formData = collectFormData();
        
        if (!signaturePad.isEmpty()) {
            formData.append('signature', signaturePad.toDataURL());
        }
        
        generatePdf(formData);
    });
    
    // Clear form
    document.getElementById('clear_btn').addEventListener('click', function() {
        document.getElementById('program_name').value = '';
        document.getElementById('print_name_title').value = '';
        document.getElementById('date_review').value = '';
        document.getElementById('date_revision').value = '';
        document.getElementById('agree_checkbox').checked = false;
        signaturePad.clear();
    });
    
    // Helper function to collect form data
    function collectFormData() {
        const formData = new FormData();
        formData.append('client_name', document.getElementById('client_name').value);
        formData.append('document_type', document.getElementById('document_type').value);
        formData.append('program_name', document.getElementById('program_name').value);
        formData.append('print_name_title', document.getElementById('print_name_title').value);
        formData.append('date_review', document.getElementById('date_review').value);
        formData.append('date_revision', document.getElementById('date_revision').value);
        return formData;
    }
    
    // Preview document function
    function previewDocument(formData) {
        fetch('/preview_pdf', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.text();
        })
        .then(html => {
            // Create a new window with the preview
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(html);
            previewWindow.document.close();
        })
        .catch(error => {
            console.error('Error previewing document:', error);
            alert('Error previewing document: ' + error.message);
        });
    }
    
    // Generate PDF function
    function generatePdf(formData) {
        // Using form submission approach for file download
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/generate_pdf';
        form.target = '_blank';
        
        for (const [key, value] of formData.entries()) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
});

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>
</html>
